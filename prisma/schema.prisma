generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                     String               @id @default(cuid())
  email                  String               @unique
  password               String?
  name                   String?
  image                  String?
  cfaLevel               CFALevel             @default(LEVEL_1)
  subscription           SubscriptionType     @default(FREE)
  role                   UserRole             @default(USER)
  subscriptionEndsAt     DateTime?
  createdAt              DateTime             @default(now())
  updatedAt              DateTime             @updatedAt
  currentStreak          Int                  @default(0)
  lastActiveAt           DateTime?
  longestStreak          Int                  @default(0)
  coins                  Int                  @default(0)
  chatCount              Int                  @default(0)
  chatResetTime          DateTime?
  hasCompletedOnboarding Boolean?             @default(false)
  chatSessions           ChatSession[]
  dailyProgress          DailyProgress[]
  itemSetAttempts        ItemSetAttempt[]
  quizAttempts           QuizAttempt[]
  studyPlans             StudyPlan[]
  topicPerformances      TopicPerformance[]
  transactions           Transaction[]
  moduleProgress         UserModuleProgress[]
  wrongQuestions         WrongQuestion[]
  feedbacks              Feedback[]
}

model Topic {
  id                String              @id @default(cuid())
  name              String
  slug              String              @unique
  description       String?
  cfaLevel          CFALevel
  order             Int
  parentId          String?
  itemSets          ItemSet[]
  los               LearningObjective[]
  questions         Question[]
  studyPlanItems    StudyPlanItem[]
  parent            Topic?              @relation("TopicChildren", fields: [parentId], references: [id])
  children          Topic[]             @relation("TopicChildren")
  topicPerformances TopicPerformance[]
}

model LearningObjective {
  id          String     @id @default(cuid())
  code        String     @unique
  description String
  topicId     String
  itemSets    ItemSet[]
  topic       Topic      @relation(fields: [topicId], references: [id])
  questions   Question[]
}

model Question {
  id             String                 @id @default(cuid())
  content        String
  optionA        String
  optionB        String
  optionC        String
  correctAnswer  String
  explanation    String
  formula        String?
  difficulty     Difficulty             @default(MEDIUM)
  topicId        String
  losId          String?
  cfaLevel       CFALevel
  createdAt      DateTime               @default(now())
  embedding      Unsupported("vector")?
  los            LearningObjective?     @relation(fields: [losId], references: [id])
  topic          Topic                  @relation(fields: [topicId], references: [id])
  quizQuestions  QuizQuestion[]
  wrongQuestions WrongQuestion[]

  @@index([topicId, difficulty])
  @@index([embedding])
}

model WrongQuestion {
  id         String   @id @default(cuid())
  userId     String
  questionId String
  createdAt  DateTime @default(now())
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, questionId])
  @@index([userId])
}

model ItemSet {
  id        String             @id @default(cuid())
  title     String
  vignette  String
  topicId   String
  losId     String?
  cfaLevel  CFALevel           @default(LEVEL_2)
  timeLimit Int                @default(18)
  createdAt DateTime           @default(now())
  los       LearningObjective? @relation(fields: [losId], references: [id])
  topic     Topic              @relation(fields: [topicId], references: [id])
  attempts  ItemSetAttempt[]
  questions ItemSetQuestion[]
}

model ItemSetQuestion {
  id            String          @id @default(cuid())
  itemSetId     String
  order         Int
  content       String
  optionA       String
  optionB       String
  optionC       String
  correctAnswer String
  explanation   String
  formula       String?
  answers       ItemSetAnswer[]
  itemSet       ItemSet         @relation(fields: [itemSetId], references: [id], onDelete: Cascade)
}

model QuizAttempt {
  id             String         @id @default(cuid())
  userId         String
  cfaLevel       CFALevel
  mode           QuizMode       @default(PRACTICE)
  timeLimit      Int?
  startedAt      DateTime       @default(now())
  completedAt    DateTime?
  score          Float?
  totalQuestions Int
  correctAnswers Int            @default(0)
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  questions      QuizQuestion[]

  @@index([userId])
  @@index([userId, startedAt(sort: Desc)])
}

model QuizQuestion {
  id            String      @id @default(cuid())
  quizAttemptId String
  questionId    String
  order         Int
  userAnswer    String?
  isCorrect     Boolean?
  timeTaken     Int?
  answeredAt    DateTime?
  question      Question    @relation(fields: [questionId], references: [id])
  quizAttempt   QuizAttempt @relation(fields: [quizAttemptId], references: [id], onDelete: Cascade)
}

model ItemSetAttempt {
  id             String          @id @default(cuid())
  userId         String
  itemSetId      String
  startedAt      DateTime        @default(now())
  completedAt    DateTime?
  score          Float?
  totalQuestions Int
  correctAnswers Int             @default(0)
  answers        ItemSetAnswer[]
  itemSet        ItemSet         @relation(fields: [itemSetId], references: [id])
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model ItemSetAnswer {
  id         String          @id @default(cuid())
  attemptId  String
  questionId String
  userAnswer String?
  isCorrect  Boolean?
  timeTaken  Int?
  answeredAt DateTime?
  attempt    ItemSetAttempt  @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question   ItemSetQuestion @relation(fields: [questionId], references: [id])
}

model TopicPerformance {
  id            String    @id @default(cuid())
  userId        String
  topicId       String
  totalAttempts Int       @default(0)
  correctCount  Int       @default(0)
  accuracy      Float     @default(0)
  lastPracticed DateTime?
  topic         Topic     @relation(fields: [topicId], references: [id])
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, topicId])
}

model DailyProgress {
  id                String   @id @default(cuid())
  userId            String
  date              DateTime @db.Date
  questionsAnswered Int      @default(0)
  correctAnswers    Int      @default(0)
  timeSpent         Int      @default(0)
  sessionsCount     Int      @default(0)
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
}

model StudyPlan {
  id        String          @id @default(cuid())
  userId    String
  name      String
  cfaLevel  CFALevel
  examDate  DateTime
  startDate DateTime        @default(now())
  isActive  Boolean         @default(true)
  createdAt DateTime        @default(now())
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     StudyPlanItem[]

  @@index([userId])
}

model StudyPlanItem {
  id          String    @id @default(cuid())
  studyPlanId String
  topicId     String
  weekNumber  Int
  targetDate  DateTime
  isCompleted Boolean   @default(false)
  completedAt DateTime?
  studyPlan   StudyPlan @relation(fields: [studyPlanId], references: [id], onDelete: Cascade)
  topic       Topic     @relation(fields: [topicId], references: [id])
}

model Book {
  id          String    @id @default(cuid())
  title       String
  description String?
  coverImage  String?
  level       CFALevel?
  createdAt   DateTime  @default(now())
  readings    Reading[]
}

model Reading {
  id        String   @id @default(cuid())
  bookId    String
  code      String
  title     String
  order     Int
  pageStart Int?
  pageEnd   Int?
  createdAt DateTime @default(now())
  modules   Module[]
  book      Book     @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@unique([bookId, order])
  @@index([bookId])
}

model Module {
  id            String               @id @default(cuid())
  readingId     String
  code          String
  title         String
  order         Int
  chunks        LessonChunk[]
  lessonContent LessonContent?
  reading       Reading              @relation(fields: [readingId], references: [id], onDelete: Cascade)
  quizHeader    ModuleQuizHeader?
  progress      UserModuleProgress[]

  @@unique([readingId, code])
  @@index([readingId, order])
}

model LessonContent {
  id        String   @id @default(cuid())
  moduleId  String   @unique
  content   String
  updatedAt DateTime @updatedAt
  module    Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
}

model UserModuleProgress {
  id          String    @id @default(cuid())
  userId      String
  moduleId    String
  isCompleted Boolean   @default(false)
  lastViewed  DateTime  @default(now())
  completedAt DateTime?
  module      Module    @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, moduleId])
  @@index([userId])
}

model ModuleQuizHeader {
  id         String               @id @default(cuid())
  moduleId   String               @unique
  title      String
  studyNotes Json?
  module     Module               @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  questions  ModuleQuizQuestion[]
}

model ModuleQuizQuestion {
  id          String                 @id @default(cuid())
  headerId    String
  questionNo  Int
  prompt      String
  optionA     String
  optionB     String
  optionC     String
  correct     AnswerChoice           @default(B)
  explanation String?
  embedding   Unsupported("vector")?
  header      ModuleQuizHeader       @relation(fields: [headerId], references: [id], onDelete: Cascade)

  @@unique([headerId, questionNo])
  @@index([headerId])
  @@index([embedding])
}

model ExamWindow {
  id          String   @id
  sessionName String   @unique
  startDate   DateTime @db.Date
  endDate     DateTime @db.Date
  isActive    Boolean  @default(true)
  updatedAt   DateTime @default(now())
}

model Transaction {
  id        String   @id @default(cuid())
  userId    String
  orderId   String   @unique
  planName  String
  amount    Float
  currency  String   @default("USD")
  status    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model LessonChunk {
  id        String                 @id @default(cuid())
  moduleId  String
  content   String
  type      ChunkType              @default(TEXT)
  embedding Unsupported("vector")?
  createdAt DateTime               @default(now())
  module    Module                 @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@index([moduleId])
  @@index([embedding])
}

model ChatSession {
  id        String        @id @default(cuid())
  userId    String
  title     String?       @default("New Chat")
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  messages  ChatMessage[]
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([updatedAt(sort: Desc)])
}

model ChatMessage {
  id        String      @id @default(cuid())
  sessionId String
  role      String
  content   String
  image     String?
  createdAt DateTime    @default(now())
  session   ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([createdAt])
}

enum CFALevel {
  LEVEL_1
  LEVEL_2
  LEVEL_3
}

enum SubscriptionType {
  FREE
  PRO
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum QuizMode {
  PRACTICE
  TIMED
  EXAM
}

enum AnswerChoice {
  A
  B
  C
}

enum ChunkType {
  TEXT
  FORMULA
  EXAMPLE
  KEY_CONCEPT
  QUIZ
}

enum UserRole {
  USER
  ADMIN
}

model Feedback {
  id           String           @id @default(cuid())
  userId       String
  rating       Int
  category     FeedbackCategory @default(GENERAL)
  strengths    String?
  weaknesses   String?
  bugs         String?
  improvements String?
  content      String?
  createdAt    DateTime         @default(now())
  user         User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

enum FeedbackCategory {
  GENERAL
  AI_ACCURACY
  UI_UX
  CONTENT
  BUG
  FEATURE_REQUEST
}
